# Current Version v_202305051002
# Mas info - https://3dwork.gitbook.io/3dwork.io/klipper/mejoras/macros-mejoras/cambio-filamentos-m600

[gcode_macro MOVE_PARK]
description: Aparca el cabezal de impresion, se puede ajustar en _VAR_GLOBALS.
gcode:
    {% set vg = printer["gcode_macro _VAR_GLOBALS"] %}
   
    # Se realiza el calculo de la posicion Z, X e Y se definen en _VAR_GLOBALS.
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set pos_z = printer.toolhead.position.z|float %}

    {% if pos_z < vg.z_park %}
        {% set z_safe = (vg.z_park - pos_z) %}
    {% elif pos_z < (max_z - vg.z_up) %}
        {% set z_safe = vg.z_park %}
    {% else %}
        {% set z_safe = max_z - pos_z %}
    {% endif %}

    NOTIFY TEXT="Aparcando cabezal de impresion"

    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-{vg.retract_length} F2100
    {% else %}
        NOTIFY TEXT="Temperatura baja, imposible extruir"
    {% endif %}
    
    {% if "xyz" in printer.toolhead.homed_axes %}
        G1 Z{z_safe} F6000
        G90
        G1 X{vg.x_park} Y{vg.y_park} F6000
    {% else %}
        NOTIFY TEXT="Ejes no inicializados.(HOME_ALL)"
    {% endif %}
